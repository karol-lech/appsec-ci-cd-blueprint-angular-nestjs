name: Secure Pipeline (SPVS L1)

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: '0 0 * * 0'

permissions:
  actions: read
  contents: read
  security-events: write

concurrency:
  group: secure-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependency-review:
    runs-on: ubuntu-latest
    needs: secret-scan
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v5
      - uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

  sast-analysis:
    runs-on: ubuntu-latest
    needs: secret-scan
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']
    steps:
      - uses: actions/checkout@v5
      - uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - uses: github/codeql-action/autobuild@v4
      - name: codeql analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"

  trivy-scan:
    runs-on: ubuntu-latest
    needs: sast-analysis
    steps:
      - uses: actions/checkout@v5
      - uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db
      - name: fs scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          ignore-unfixed: false
          format: sarif
          output: trivy-fs.sarif
          severity: CRITICAL,HIGH
          exit-code: 1
      - uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-fs.sarif

  build-and-test:
    runs-on: ubuntu-latest
    needs: trivy-scan
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: npm
      - name: install dependencies
        run: npm ci
      - name: lint
        run: npx nx affected:lint --base=origin/master --parallel=3
      - name: unit tests
        run: npx nx affected:test --base=origin/master --ci --coverage --coverageThreshold 80
      - name: production builds
        run: npx nx affected:build --base=origin/master --configuration=production

  dast-zap:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v6
      - name: install dependencies
        run: npm ci
      - name: build backend
        run: npx nx build backend --configuration=production
      - name: build frontend
        run: node scripts/replace-env.js && npx nx build frontend --configuration=production
        env:
          BACKEND_URL: http://localhost:3000
      - name: start backend
        run: node dist/apps/backend/main.js & sleep 5
      - name: start frontend
        run: npx http-server dist/apps/frontend -p 8080 & sleep 5
      - name: ZAP baseline scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: 'http://localhost:8080'
          allow_issue_writing: false
